package create

import (
	"awesomeProject8/database"
	"context"
	"fmt"
	"regexp"
	"strconv"
	"strings"

	"gorm.io/gorm"
)

func getTable(db *gorm.DB) string {
	tableName := db.Statement.Table
	ctx := context.Background()
	result, err := database.DbManager.Redis.Get(ctx, tableName).Result()
	if err != nil {
		fmt.Printf("从 Redis 获取表名列表失败: %v\n", err)
		return ""
	}

	tables := strings.Split(result, ",")
	tmpRes := ""
	if len(tables) == 0 {
		tmpRes = tableName + "01"
		err = createTableIfNotExists(db, tmpRes)
		if err != nil {
			return ""
		}
		return tmpRes
	}
	var count int64
	tmpRes = tables[len(tables)-1]
	err = db.Table(tmpRes).Count(&count).Error
	if err != nil {
		return ""
	}
	if count >= 10000000 {
		tmpRes, err = incrementTableNumber(tmpRes)
		if err != nil {
			return ""
		}
		err = createTableIfNotExists(db, tmpRes)
		if err != nil {
			return ""
		}
	}

	return tmpRes
}
func incrementTableNumber(tableName string) (string, error) {
	re := regexp.MustCompile(`_(\d+)$`)
	matches := re.FindStringSubmatch(tableName)
	if len(matches) < 2 {
		return "", fmt.Errorf("表名格式错误，无编号后缀: %s", tableName)
	}

	prefix := strings.Replace(tableName, matches[0], "", 1)
	num, err := strconv.Atoi(matches[1])
	if err != nil {
		return "", fmt.Errorf("解析表名编号失败: %v", err)
	}

	nextNum := num + 1
	return fmt.Sprintf("%s_%02d", prefix, nextNum), nil
}
func createTableIfNotExists(db *gorm.DB, newTableName string) error {

	tx := db.Session(&gorm.Session{})
	tx.Statement.Table = newTableName

	if err := tx.AutoMigrate(tx.Statement.Model); err != nil {
		return fmt.Errorf("创建新表 %s 失败: %w", newTableName, err)
	}

	fmt.Printf("✅ 成功创建新分表: %s\n", newTableName)
	return nil
}
